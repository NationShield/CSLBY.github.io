<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Launcher</title>
    <style>
        /* Стили остаются такими же как в вашем коде */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* ... все ваши стили остаются без изменений ... */

        .path-history {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
        }

        .history-title {
            font-size: 14px;
            color: #888888;
            margin-bottom: 10px;
            text-align: left;
        }

        .history-item {
            padding: 8px 12px;
            background: rgba(0, 170, 255, 0.1);
            border: 1px solid rgba(0, 170, 255, 0.2);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #cccccc;
            text-align: left;
            transition: all 0.2s ease;
            word-break: break-all;
            position: relative;
        }

        .history-item:hover {
            background: rgba(0, 170, 255, 0.2);
            border-color: #00aaff;
        }

        .history-remove {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff5555;
            font-size: 18px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .history-item:hover .history-remove {
            opacity: 1;
        }

        .clear-history-btn {
            background: transparent;
            color: #ff5555;
            border: 1px solid #ff5555;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .clear-history-btn:hover {
            background: rgba(255, 85, 85, 0.1);
        }
    </style>
</head>
<body>
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <h1 class="welcome-title">CS Launcher</h1>
            <div class="welcome-subtitle">Лаунчер для Counter-Strike</div>
            <div class="welcome-text">
                Наслаждайтесь удобным запуском CS2 и CS:GO с возможностью настройки путей.
            </div>
            <button class="continue-btn" onclick="startSetup()">Продолжить</button>
        </div>
    </div>

    <div class="setup-screen" id="setupScreen">
        <div class="setup-content">
            <h2 class="setup-title">Настройка пути к CS:GO</h2>
            <div class="setup-text">
                Для запуска CS:GO укажите путь к папке с игрой.<br>
                Путь будет сохранен и использоваться для будущих запусков.
            </div>
            <div class="path-input-group">
                <input type="text" id="gamePath" class="path-input" 
                       placeholder="C:\Program Files\Steam\steamapps\common\Counter-Strike Global Offensive"
                       list="pathHistory">
                <button class="save-path-btn" onclick="saveGamePath()">Сохранить</button>
            </div>
            
            <!-- Автозаполнение из истории -->
            <datalist id="pathHistory"></datalist>
            
            <div class="path-example">
                Пример: C:\Program Files\Steam\steamapps\common\Counter-Strike Global Offensive
            </div>
            
            <!-- История путей -->
            <div class="path-history" id="pathHistoryContainer" style="display: none;">
                <div class="history-title">История путей:</div>
                <div id="historyList"></div>
                <button class="clear-history-btn" onclick="clearHistory()">Очистить историю</button>
            </div>
            
            <div class="status" id="setupStatus" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div class="connection-status" id="connectionStatus"></div>

    <button class="settings-btn" id="settingsBtn" style="display: none;" onclick="showSettings()">
        ⚙️ Настройки
    </button>

    <div class="launcher" id="mainLauncher">
        <div class="header">
            <h1>CS Launcher</h1>
            <p>Select game and launch</p>
        </div>

        <div class="games">
            <div class="game active" onclick="selectGame('cs2')">
                <div class="game-image">
                    <img src="https://raw.githubusercontent.com/NationShield/CSLBY.github.io/refs/heads/main/IMG/cs2.jpg" alt="CS2">
                </div>
                <div class="game-name">CS2</div>
            </div>

            <div class="game" onclick="selectGame('csgo')">
                <div class="game-image">
                    <img src="https://raw.githubusercontent.com/NationShield/CSLBY.github.io/refs/heads/main/IMG/csgo.jpg" alt="CS:GO">
                </div>
                <div class="game-name">CS:GO</div>
            </div>
        </div>

        <div class="controls">
            <div class="status" id="status">Готово к запуску</div>
            <div class="game-info" id="gameInfo">Выбрана игра: CS2 (запуск через Steam)</div>
            <button class="launch-btn" onclick="launchGame()" id="launchBtn">
                Launch Game
            </button>
        </div>
    </div>

    <div class="notification" id="notification">
        Launching game...
    </div>

    <script>
        // Инициализация хранилища
        const STORAGE_KEYS = {
            CURRENT_PATH: 'csgo_game_path',
            PATH_HISTORY: 'csgo_path_history',
            LAUNCH_COUNT: 'csgo_launch_count',
            LAST_LAUNCH: 'csgo_last_launch',
            USER_PREFERENCES: 'csgo_user_prefs'
        };

        // Конфигурация
        const CONFIG = {
            MAX_HISTORY_ITEMS: 10,
            AUTO_SAVE_HISTORY: true
        };

        // Инициализация при загрузке
        let selectedGame = 'cs2';
        let savedGamePath = '';
        let pathHistory = [];
        let ws = null;
        let gameProcessId = null;
        
        // Основные данные приложения
        let appData = {
            paths: [],
            settings: {
                autoSaveHistory: true,
                maxHistoryItems: 10,
                lastUsedGame: 'cs2',
                theme: 'dark'
            },
            statistics: {
                totalLaunches: 0,
                cs2Launches: 0,
                csgoLaunches: 0,
                lastLaunchTime: null,
                favorites: []
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            initializeApp();
        });
        
        function loadAllData() {
            // Загружаем текущий путь
            savedGamePath = localStorage.getItem(STORAGE_KEYS.CURRENT_PATH) || '';
            
            // Загружаем историю путей
            const historyJson = localStorage.getItem(STORAGE_KEYS.PATH_HISTORY);
            if (historyJson) {
                try {
                    pathHistory = JSON.parse(historyJson);
                } catch (e) {
                    console.error('Ошибка загрузки истории:', e);
                    pathHistory = [];
                }
            }
            
            // Загружаем настройки пользователя
            const prefsJson = localStorage.getItem(STORAGE_KEYS.USER_PREFERENCES);
            if (prefsJson) {
                try {
                    const prefs = JSON.parse(prefsJson);
                    appData.settings = { ...appData.settings, ...prefs };
                } catch (e) {
                    console.error('Ошибка загрузки настроек:', e);
                }
            }
            
            // Загружаем статистику
            appData.statistics.totalLaunches = parseInt(localStorage.getItem(STORAGE_KEYS.LAUNCH_COUNT) || '0');
            const lastLaunch = localStorage.getItem(STORAGE_KEYS.LAST_LAUNCH);
            if (lastLaunch) {
                appData.statistics.lastLaunchTime = new Date(lastLaunch);
            }
        }
        
        function saveAllData() {
            // Сохраняем текущий путь
            if (savedGamePath) {
                localStorage.setItem(STORAGE_KEYS.CURRENT_PATH, savedGamePath);
            }
            
            // Сохраняем историю путей
            localStorage.setItem(STORAGE_KEYS.PATH_HISTORY, JSON.stringify(pathHistory));
            
            // Сохраняем настройки
            localStorage.setItem(STORAGE_KEYS.USER_PREFERENCES, JSON.stringify(appData.settings));
            
            // Сохраняем статистику запусков
            localStorage.setItem(STORAGE_KEYS.LAUNCH_COUNT, appData.statistics.totalLaunches.toString());
            
            if (appData.statistics.lastLaunchTime) {
                localStorage.setItem(STORAGE_KEYS.LAST_LAUNCH, appData.statistics.lastLaunchTime.toISOString());
            }
        }
        
        function addToHistory(path) {
            if (!path || path.trim() === '') return;
            
            // Удаляем дубликаты
            const index = pathHistory.indexOf(path);
            if (index !== -1) {
                pathHistory.splice(index, 1);
            }
            
            // Добавляем в начало
            pathHistory.unshift(path);
            
            // Ограничиваем количество записей
            if (pathHistory.length > CONFIG.MAX_HISTORY_ITEMS) {
                pathHistory = pathHistory.slice(0, CONFIG.MAX_HISTORY_ITEMS);
            }
            
            // Сохраняем историю
            localStorage.setItem(STORAGE_KEYS.PATH_HISTORY, JSON.stringify(pathHistory));
            
            // Обновляем отображение истории
            updateHistoryDisplay();
        }
        
        function removeFromHistory(path) {
            const index = pathHistory.indexOf(path);
            if (index !== -1) {
                pathHistory.splice(index, 1);
                localStorage.setItem(STORAGE_KEYS.PATH_HISTORY, JSON.stringify(pathHistory));
                updateHistoryDisplay();
            }
        }
        
        function clearHistory() {
            if (confirm('Вы уверены, что хотите очистить всю историю путей?')) {
                pathHistory = [];
                localStorage.removeItem(STORAGE_KEYS.PATH_HISTORY);
                updateHistoryDisplay();
                showNotification('История путей очищена');
            }
        }
        
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const historyContainer = document.getElementById('pathHistoryContainer');
            const datalist = document.getElementById('pathHistory');
            
            if (!historyList) return;
            
            // Очищаем список
            historyList.innerHTML = '';
            datalist.innerHTML = '';
            
            if (pathHistory.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }
            
            historyContainer.style.display = 'block';
            
            // Добавляем элементы в datalist для автозаполнения
            pathHistory.forEach(path => {
                const option = document.createElement('option');
                option.value = path;
                datalist.appendChild(option);
            });
            
            // Добавляем элементы в историю
            pathHistory.forEach(path => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    ${path}
                    <span class="history-remove" onclick="removeFromHistory('${path.replace(/'/g, "\\'")}')">×</span>
                `;
                
                historyItem.onclick = function(e) {
                    if (!e.target.classList.contains('history-remove')) {
                        document.getElementById('gamePath').value = path;
                    }
                };
                
                historyList.appendChild(historyItem);
            });
        }
        
        function saveGamePath() {
            const pathInput = document.getElementById('gamePath');
            const path = pathInput.value.trim();
            const setupStatus = document.getElementById('setupStatus');
            
            if (path) {
                // Сохраняем путь
                savedGamePath = path;
                localStorage.setItem(STORAGE_KEYS.CURRENT_PATH, path);
                
                // Добавляем в историю
                addToHistory(path);
                
                setupStatus.textContent = '✓ Путь успешно сохранен!';
                setupStatus.style.color = '#00ffaa';
                
                // Обновляем статистику
                appData.statistics.totalLaunches++;
                saveAllData();
                
                showNotification('Путь к CS:GO сохранен');
                
                setTimeout(() => {
                    document.getElementById('setupScreen').classList.remove('active');
                    document.getElementById('setupScreen').classList.add('fade-out');
                    
                    setTimeout(() => {
                        showMainLauncher();
                    }, 800);
                }, 1000);
            } else {
                setupStatus.textContent = '✗ Введите путь к папке с игрой';
                setupStatus.style.color = '#ff5555';
            }
        }
        
        function initializeApp() {
            if (savedGamePath) {
                document.getElementById('welcomeScreen').style.display = 'none';
                showMainLauncher();
            }
            
            // Показываем историю при загрузке настроек
            updateHistoryDisplay();
            
            // Подключаемся к лаунчеру
            connectToLauncher();
            
            // Восстанавливаем последнюю выбранную игру
            if (appData.settings.lastUsedGame) {
                selectedGame = appData.settings.lastUsedGame;
                selectGame(selectedGame, true);
            }
        }
        
        function selectGame(game, silent = false) {
            if (!savedGamePath && game === 'csgo' && !silent) {
                showNotification('Сначала укажите путь к CS:GO в настройках!');
                return;
            }
            
            if (!silent) {
                document.querySelectorAll('.game').forEach(gameElement => {
                    gameElement.classList.remove('active');
                });
                
                event.currentTarget.classList.add('active');
            }
            
            selectedGame = game;
            appData.settings.lastUsedGame = game;
            saveAllData();
            
            updateGameStatus();
        }
        
        function showSettings() {
            document.getElementById('setupScreen').style.display = 'flex';
            document.getElementById('setupScreen').classList.remove('fade-out');
            document.getElementById('setupScreen').classList.add('active');
            document.getElementById('mainLauncher').classList.remove('active');
            
            if (savedGamePath) {
                document.getElementById('gamePath').value = savedGamePath;
            }
            
            // Показываем историю
            updateHistoryDisplay();
            
            document.getElementById('setupStatus').textContent = '';
        }
        
        // Остальные функции остаются без изменений
        // (connectToLauncher, handleLauncherMessage, sendToLauncher, updateConnectionStatus,
        // startSetup, showMainLauncher, updateGameStatus, launchGame, showNotification)
        
        // WebSocket функции остаются без изменений
        function connectToLauncher() {
            try {
                ws = new WebSocket('ws://localhost:8765');
                
                ws.onopen = function() {
                    updateConnectionStatus(true);
                    console.log('Connected to launcher');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleLauncherMessage(data);
                };
                
                ws.onclose = function() {
                    updateConnectionStatus(false);
                    setTimeout(connectToLauncher, 3000);
                };
                
                ws.onerror = function() {
                    updateConnectionStatus(false);
                };
            } catch (e) {
                console.error('WebSocket error:', e);
                updateConnectionStatus(false);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = '✓ Подключено к лаунчеру';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '✗ Нет подключения к лаунчеру';
                statusElement.className = 'connection-status disconnected';
            }
        }
        
        function handleLauncherMessage(data) {
            console.log('Message from launcher:', data);
            
            if (data.type === 'game_started') {
                document.getElementById('status').textContent = 'Игра запущена, отслеживание...';
                gameProcessId = data.pid;
                showNotification('Игра успешно запущена');
            }
            else if (data.type === 'game_closed') {
                document.getElementById('status').textContent = 'Игра закрыта, восстановление настроек...';
                showNotification('Игра закрыта, настройки восстановлены');
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Готово к запуску';
                }, 2000);
                gameProcessId = null;
            }
            else if (data.type === 'version_modified') {
                document.getElementById('status').textContent = 'Версия изменена на ' + data.new_version;
            }
            else if (data.type === 'version_restored') {
                document.getElementById('status').textContent = 'Версия восстановлена: ' + data.original_version;
            }
            else if (data.type === 'error') {
                document.getElementById('status').textContent = 'Ошибка: ' + data.message;
                showNotification('Ошибка: ' + data.message);
            }
        }
        
        function sendToLauncher(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
                return true;
            }
            return false;
        }
        
        // Защита от копирования/право клика
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        function startSetup() {
            document.getElementById('welcomeScreen').classList.add('fade-out');
            
            setTimeout(() => {
                document.getElementById('setupScreen').classList.add('active');
                document.getElementById('welcomeScreen').style.display = 'none';
                
                if (savedGamePath) {
                    document.getElementById('gamePath').value = savedGamePath;
                }
            }, 1000);
        }
        
        function showMainLauncher() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('settingsBtn').style.display = 'block';
            document.getElementById('mainLauncher').classList.add('active');
            
            updateGameStatus();
        }
        
        function updateGameStatus() {
            const status = document.getElementById('status');
            const gameInfo = document.getElementById('gameInfo');
            
            if (selectedGame === 'cs2') {
                status.textContent = 'Готово к запуску CS2 через Steam';
                gameInfo.textContent = 'Выбрана игра: CS2 (запуск через Steam)';
            } else {
                if (savedGamePath) {
                    status.textContent = 'Готово к запуску CS:GO через лаунчер';
                    gameInfo.textContent = 'Выбрана игра: CS:GO (запуск через лаунчер)';
                } else {
                    status.textContent = 'Укажите путь к CS:GO в настройках';
                    gameInfo.textContent = 'Выбрана игра: CS:GO (требуется указать путь)';
                }
            }
        }
        
        function launchGame() {
            const btn = document.getElementById('launchBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.textContent = 'Запуск...';
            
            // Обновляем статистику
            appData.statistics.totalLaunches++;
            appData.statistics.lastLaunchTime = new Date();
            
            if (selectedGame === 'cs2') {
                appData.statistics.cs2Launches++;
            } else {
                appData.statistics.csgoLaunches++;
            }
            
            saveAllData();
            
            if (selectedGame === 'cs2') {
                status.textContent = 'Запуск CS2 через Steam...';
                showNotification('Запуск CS2 через Steam');
                
                setTimeout(() => {
                    window.location.href = 'steam://run/730';
                    
                    setTimeout(() => {
                        showNotification('CS2 запускается через Steam');
                        status.textContent = 'CS2 запускается...';
                        
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.textContent = 'Launch Game';
                            status.textContent = 'CS2 запущен - проверьте Steam';
                        }, 3000);
                    }, 1000);
                }, 1500);
                
            } else if (selectedGame === 'csgo') {
                if (!savedGamePath) {
                    showNotification('Сначала укажите путь к папке CS:GO в настройках!');
                    status.textContent = 'Ошибка: путь к CS:GO не указан';
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Launch Game';
                        status.textContent = 'Укажите путь к CS:GO в настройках';
                    }, 2000);
                    return;
                }
                
                if (!sendToLauncher({
                    type: 'launch_csgo',
                    game_path: savedGamePath
                })) {
                    showNotification('Нет подключения к лаунчеру!');
                    status.textContent = 'Ошибка: нет подключения к лаунчеру';
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Launch Game';
                        status.textContent = 'Переподключитесь к лаунчеру';
                    }, 2000);
                    return;
                }
                
                status.textContent = 'Отправка запроса лаунчеру...';
                showNotification('Запрос на запуск CS:GO отправлен');
                
                setTimeout(() => {
                    status.textContent = 'Лаунчер обрабатывает запрос...';
                }, 1000);
            }
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
